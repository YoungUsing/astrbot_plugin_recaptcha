# 新成员验证插件

一个基于AstrBot的插件，用于新成员入群时进行外部reCAPTCHA验证。

## 功能特性

- 🛡️ **自动验证**：新成员入群自动触发验证流程
- 🔄 **重新触发**：管理员可为用户重新触发验证
- 📊 **状态查询**：实时查看用户验证状态
- ⚡ **强制通过**：超级管理员可强制通过验证
- ⏱️ **超时提醒**：验证超时自动@管理员处理
- 🔧 **灵活配置**：支持自定义验证超时时间
- 📝 **完整日志**：详细的操作日志记录

## 安装方法

### 方法一：从插件市场安装
1. 打开AstrBot的WebUI
2. 进入插件市场
3. 搜索"新成员验证插件"
4. 点击安装
5. 这段是AI瞎写的

### 方法二：手动安装
1. 克隆插件仓库：
   ```bash
   cd AstrBot/data/plugins
   git clone https://github.com/YoungUsing/astrbot_plugin_recaptcha
   ```
2. 重启AstrBot或重载插件

## 配置说明

### 必要配置
0. 初始化验证服务：基于 https://github.com/YoungUsing/reCAPTCHA-workers 构建
1. **encsec**：与验证网站一致的验证密钥
2. **admin_id**：超时后需要@的管理员ID（QQ号或其他平台ID）

### 可选配置
1. **super_admin_ids**：超级管理员ID列表（可执行所有管理命令）
2. **timeout_minutes**：验证超时时间（分钟，默认5分钟）
3. **enable_help_command**：是否启用帮助命令（默认启用）

## 使用方法

### 验证流程
1. **自动触发**：新成员入群时自动发送验证指引
2. **用户操作**：
   - 访问提供的验证网站
   - 输入系统提供的验证码
   - 将网站返回的代码发送到群内
3. **系统验证**：自动验证并提示结果

### 管理员命令

#### 1. 重新触发验证
```bash
# 多种命令格式
/recaptcha @用户
/重新验证 @用户
/触发验证 @用户
/验证触发 @用户
/验证 重新触发 @用户
```

#### 2. 检查验证状态
```bash
/check_verification @用户
/检查验证 @用户
/验证状态 @用户
/验证查询 @用户
/验证 状态 @用户
```

#### 3. 强制通过验证（仅超级管理员）
```bash
/clear_verification @用户
/清除验证 @用户
/强制通过 @用户
/跳过验证 @用户
/验证 强制通过 @用户
```

#### 4. 查看帮助
```bash
/captcha_help
/验证帮助
/验证指令
/帮助
/验证 帮助
```

### 权限说明
- **普通管理员**：可以使用`/recaptcha`和`/check_verification`命令
- **超级管理员**：可以使用所有命令，包括`/clear_verification`
- **普通用户**：只能进行自己的验证操作

## 技术细节

### 验证机制
1. **随机码生成**：每次验证生成8位随机字母数字组合
2. **验证流程**：
   - 用户输入验证码到验证网站
   - 网站返回加密代码
   - 插件POST验证并解密
   - 检查解密结果是否包含原始随机码
3. **超时处理**：超时后自动清理验证记录并@管理员

### 数据存储
- **内存存储**：验证数据存储在内存中
- **自动清理**：后台任务定期清理过期记录
- **重启失效**：插件重启后验证记录会丢失

## 故障排除

### 常见问题

#### 1. 验证不触发
- 检查插件是否正常加载
- 确认encsec配置正确
- 查看日志文件是否有错误信息

#### 2. 验证失败
- 检查网络是否可访问验证服务
- 确认验证码输入正确
- 查看验证密钥是否过期

#### 3. 消息发送失败
- 检查平台适配器配置
- 确认机器人有群聊发送权限
- 查看网络连接状态

### 日志查看
```bash
# 查看AstrBot日志
tail -f logs/astrbot.log

# 查看插件日志
grep "new_member_captcha" logs/astrbot.log
```

## 开发说明

### 依赖库
- aiohttp：用于HTTP请求
- asyncio：异步任务处理
- random：随机码生成
- string：字符串处理

### 项目结构
```
astrbot_plugin_recaptcha/
├── main.py              # 主程序文件
├── metadata.yaml        # 插件元数据
├── conf_schema.json     # 配置架构
└── README.md           # 说明文档
```

---

**注意**：本插件依赖于外部验证服务，请确保服务可用性。